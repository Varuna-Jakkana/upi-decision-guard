{% extends "base.html" %}

{% block extra_scripts %}
<!-- Google Charts loader -->
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script>
  google.charts.load('current', { packages: ['corechart'] });
  google.charts.setOnLoadCallback(drawBudgetChart);

  function drawBudgetChart() {
    var data = google.visualization.arrayToDataTable([
      ['Label', 'Amount'],
      ['Spent', {{ total_spent|default (0) }}],
  ['Remaining', {{ remaining|default (0) }}]
    ]);

  var options = {
    title: 'Budget vs Spent',
    pieHole: 0.4,
    legend: { position: 'bottom' },
    chartArea: { width: '90%', height: '70%' }
  };

  var chart = new google.visualization.PieChart(
    document.getElementById('budgetChart')
  );
  chart.draw(data, options);
  }
</script>
{% endblock %}

{% block content %}
<div class="glass-card fade-in-up" style="max-width: 1200px; margin: 0 auto;">

  <!-- Quick Stats Row -->
  <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
    <div class="glass-card"
      style="padding: 2rem; text-align: center; background: linear-gradient(135deg, rgba(16,185,129,0.2), rgba(5,150,105,0.2));">
      <div style="font-size: 2.5rem; color: #10b981; font-weight: bold;">
        â‚¹{{ "%.0f"|format(total_spent) }}
      </div>
      <div style="color: #6b7280;">Total Spent</div>
    </div>

    <div class="glass-card"
      style="padding: 2rem; text-align: center; background: linear-gradient(135deg, rgba(245,158,11,0.2), rgba(217,119,6,0.2));">
      <div style="font-size: 2.5rem; color: #f59e0b; font-weight: bold;">
        {{ transactions|selectattr('blocked')|list|length }}
      </div>
      <div style="color: #6b7280;">Frauds Blocked</div>
    </div>

    <div class="glass-card"
      style="padding: 2rem; text-align: center; background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(30,64,175,0.2));">
      <div style="font-size: 2.5rem; color: #3b82f6; font-weight: bold;">
        â‚¹{{ "%.0f"|format(remaining) }}
      </div>
      <div style="color: #6b7280;">Remaining</div>
    </div>
  </div>

  <!-- Google Charts: Budget vs Spent -->
  <div class="glass-card" style="padding: 2.5rem; margin-bottom: 2rem;">
    <h3 style="margin-bottom: 1.5rem; text-align: center;">
      ğŸ“ˆ Budget vs Spent (Google Chart)
    </h3>
    <div id="budgetChart" style="width: 100%; max-width: 600px; height: 400px; margin: 0 auto;">
    </div>
  </div>

  <!-- Category Breakdown -->
  <div class="glass-card" style="padding: 2.5rem;">
    <h3 style="margin-bottom: 1.5rem;">ğŸ“Š Category Budgets</h3>
    <div
      style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">

      <!-- Food -->
      <div
        style="padding: 1.5rem; background: rgba(16,185,129,0.1); border-radius: 12px; border-left: 4px solid #10b981;">
        <div style="font-size: 1.5rem; font-weight: bold;">ğŸ” Food</div>
        <div style="font-size: 2rem; color: #10b981; margin: 0.5rem 0;">
          â‚¹{{ "%.0f"|format(config.budgets.Food.spent|default(0)) }}
          /
          â‚¹{{ "%.0f"|format(config.budgets.Food.limit|default(0)) }}
        </div>
        <div style="color: #6b7280;">
          {% if config.budgets.Food.limit > 0 %}
          {{ "%.0f"|format((config.budgets.Food.spent / config.budgets.Food.limit) * 100) }}% used
          {% else %}
          0% used
          {% endif %}
        </div>
      </div>

      <!-- Shopping -->
      <div
        style="padding: 1.5rem; background: rgba(245,158,11,0.1); border-radius: 12px; border-left: 4px solid #f59e0b;">
        <div style="font-size: 1.5rem; font-weight: bold;">ğŸ›’ Shopping</div>
        <div style="font-size: 2rem; color: #f59e0b; margin: 0.5rem 0;">
          â‚¹{{ "%.0f"|format(config.budgets.Shopping.spent|default(0)) }}
          /
          â‚¹{{ "%.0f"|format(config.budgets.Shopping.limit|default(0)) }}
        </div>
        <div style="color: #6b7280;">
          {% if config.budgets.Shopping.limit > 0 %}
          {{ "%.0f"|format((config.budgets.Shopping.spent / config.budgets.Shopping.limit) * 100) }}% used
          {% else %}
          0% used
          {% endif %}
        </div>
      </div>

      <!-- Entertainment -->
      <div
        style="padding: 1.5rem; background: rgba(59,130,246,0.1); border-radius: 12px; border-left: 4px solid #3b82f6;">
        <div style="font-size: 1.5rem; font-weight: bold;">ğŸ¬ Entertainment</div>
        <div style="font-size: 2rem; color: #3b82f6; margin: 0.5rem 0;">
          â‚¹{{ "%.0f"|format(config.budgets.Entertainment.spent|default(0)) }}
          /
          â‚¹{{ "%.0f"|format(config.budgets.Entertainment.limit|default(0)) }}
        </div>
        <div style="color: #6b7280;">
          {% if config.budgets.Entertainment.limit > 0 %}
          {{ "%.0f"|format((config.budgets.Entertainment.spent / config.budgets.Entertainment.limit) * 100) }}% used
          {% else %}
          0% used
          {% endif %}
        </div>
      </div>

      <!-- Bills & Utilities -->
      <div
        style="padding: 1.5rem; background: rgba(168,85,247,0.1); border-radius: 12px; border-left: 4px solid #a855f7;">
        <div style="font-size: 1.5rem; font-weight: bold;">ğŸ’¡ Bills & Utilities</div>
        <div style="font-size: 2rem; color: #a855f7; margin: 0.5rem 0;">
          â‚¹{{ "%.0f"|format(config.budgets.Bills.spent|default(0)) }}
          /
          â‚¹{{ "%.0f"|format(config.budgets.Bills.limit|default(0)) }}
        </div>
        <div style="color: #6b7280;">
          {% if config.budgets.Bills.limit > 0 %}
          {{ "%.0f"|format((config.budgets.Bills.spent / config.budgets.Bills.limit) * 100) }}% used
          {% else %}
          0% used
          {% endif %}
        </div>
      </div>

      <!-- Health & Medical -->
      <div
        style="padding: 1.5rem; background: rgba(239,68,68,0.1); border-radius: 12px; border-left: 4px solid #ef4444;">
        <div style="font-size: 1.5rem; font-weight: bold;">âš•ï¸ Health & Medical</div>
        <div style="font-size: 2rem; color: #ef4444; margin: 0.5rem 0;">
          â‚¹{{ "%.0f"|format(config.budgets.Health.spent|default(0)) }}
          /
          â‚¹{{ "%.0f"|format(config.budgets.Health.limit|default(0)) }}
        </div>
        <div style="color: #6b7280;">
          {% if config.budgets.Health.limit > 0 %}
          {{ "%.0f"|format((config.budgets.Health.spent / config.budgets.Health.limit) * 100) }}% used
          {% else %}
          0% used
          {% endif %}
        </div>
      </div>

      <!-- Savings -->
      <div
        style="padding: 1.5rem; background: rgba(34,197,94,0.1); border-radius: 12px; border-left: 4px solid #22c55e;">
        <div style="font-size: 1.5rem; font-weight: bold;">ğŸ’° Savings</div>
        <div style="font-size: 2rem; color: #22c55e; margin: 0.5rem 0;">
          â‚¹{{ "%.0f"|format(config.budgets.Savings.spent|default(0)) }}
          /
          â‚¹{{ "%.0f"|format(config.budgets.Savings.limit|default(0)) }}
        </div>
        <div style="color: #6b7280;">
          {% if config.budgets.Savings.limit > 0 %}
          {{ "%.0f"|format((config.budgets.Savings.spent / config.budgets.Savings.limit) * 100) }}% used
          {% else %}
          0% used
          {% endif %}
        </div>
      </div>

      <!-- Others -->
      <div
        style="padding: 1.5rem; background: rgba(107,114,128,0.1); border-radius: 12px; border-left: 4px solid #6b7280;">
        <div style="font-size: 1.5rem; font-weight: bold;">ğŸ“¦ Others</div>
        <div style="font-size: 2rem; color: #6b7280; margin: 0.5rem 0;">
          â‚¹{{ "%.0f"|format(config.budgets.Others.spent|default(0)) }}
          /
          â‚¹{{ "%.0f"|format(config.budgets.Others.limit|default(0)) }}
        </div>
        <div style="color: #6b7280;">
          {% if config.budgets.Others.limit > 0 %}
          {{ "%.0f"|format((config.budgets.Others.spent / config.budgets.Others.limit) * 100) }}% used
          {% else %}
          0% used
          {% endif %}
        </div>
      </div>

    </div>
  </div>
  <!-- Recent Transactions -->
  {% if transactions %}
  <div class="glass-card" style="padding: 2.5rem; margin-top: 2rem;">
    <h3 style="margin-bottom: 1.5rem;">ğŸ“œ Recent Transactions</h3>

    <div style="overflow-x: auto;">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: rgba(0,0,0,0.05); text-align: left;">
            <th style="padding: 1rem; border-bottom: 2px solid #e5e7eb;">Merchant</th>
            <th style="padding: 1rem; border-bottom: 2px solid #e5e7eb;">Category</th>
            <th style="padding: 1rem; border-bottom: 2px solid #e5e7eb;">Amount</th>
            <th style="padding: 1rem; border-bottom: 2px solid #e5e7eb;">Risk Score</th>
            <th style="padding: 1rem; border-bottom: 2px solid #e5e7eb;">Status</th>
          </tr>
        </thead>
        <tbody>
          {% for tx in transactions %}
          <tr style="border-bottom: 1px solid #f3f4f6;">
            <td style="padding: 1rem;">{{ tx.merchant }}</td>
            <td style="padding: 1rem;">
              <span
                style="background: rgba(59,130,246,0.1); color: #3b82f6; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem;">
                {{ tx.category }}
              </span>
            </td>
            <td style="padding: 1rem; font-weight: 600;">â‚¹{{ "%.0f"|format(tx.amount) }}</td>
            <td style="padding: 1rem;">
              {% if tx.risk > 70 %}
              <span style="color: #ef4444; font-weight: 600;">{{ tx.risk }}%</span>
              {% elif tx.risk > 40 %}
              <span style="color: #f59e0b; font-weight: 600;">{{ tx.risk }}%</span>
              {% else %}
              <span style="color: #10b981; font-weight: 600;">{{ tx.risk }}%</span>
              {% endif %}
            </td>
            <td style="padding: 1rem;">
              {% if tx.blocked %}
              <span
                style="background: #fee2e2; color: #dc2626; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: 600;">
                ğŸš« Blocked
              </span>
              {% else %}
              <span
                style="background: #d1fae5; color: #059669; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: 600;">
                âœ… Approved
              </span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% else %}
  <div class="glass-card" style="padding: 2.5rem; margin-top: 2rem; text-align: center; color: #6b7280;">
    <p style="font-size: 1.25rem;">No transactions yet. Add your first UPI payment to see it here!</p>
  </div>
  {% endif %}

  <!-- Action Buttons -->
  <div style="text-align: center; margin-top: 1.5rem;">
    <a href="{{ url_for('setup') }}" class="btn"
      style="background: linear-gradient(135deg, #1e40af, #3b82f6); margin-right: 1rem;">
      âœï¸ Edit Categories
    </a>
    <a href="{{ url_for('add_payment') }}" class="btn" style="background: linear-gradient(135deg, #10b981, #059669);">
      â• Add UPI Payment
    </a>
  </div>

</div>
{% endblock %}