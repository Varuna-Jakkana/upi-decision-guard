{% extends "base.html" %}

{% block extra_scripts %}
<!-- Google Charts loader -->
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script>
  google.charts.load('current', { packages: ['corechart'] });
  google.charts.setOnLoadCallback(drawBudgetChart);

  function drawBudgetChart() {
    var data = google.visualization.arrayToDataTable([
      ['Label', 'Amount'],
      ['Spent', {{ total_spent|default (0) }}],
  ['Remaining', {{ remaining|default (0) }}]
    ]);

  var options = {
    title: 'Budget vs Spent',
    pieHole: 0.4,
    legend: { position: 'bottom' },
    chartArea: { width: '90%', height: '70%' },
    colors: ['#ef4444', '#10b981'] // Red for spent, Green for remaining
  };

  var chart = new google.visualization.PieChart(
    document.getElementById('budgetChart')
  );
  chart.draw(data, options);
  }
</script>
{% endblock %}

{% block content %}
<div class="glass-card fade-in-up" style="max-width: 1000px; margin: 0 auto;">

  <!-- Quick Stats Row -->
  <div
    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
    <div class="glass-card"
      style="padding: 2rem; text-align: center; background: linear-gradient(135deg, rgba(16,185,129,0.2), rgba(5,150,105,0.2));">
      <div style="font-size: 2.5rem; color: #10b981; font-weight: bold;">
        â‚¹{{ "%.0f"|format(total_spent) }}
      </div>
      <div style="color: #6b7280;">Total Spent</div>
    </div>

    <div class="glass-card"
      style="padding: 2rem; text-align: center; background: linear-gradient(135deg, rgba(245,158,11,0.2), rgba(217,119,6,0.2));">
      <div style="font-size: 2.5rem; color: #f59e0b; font-weight: bold;">
        {{ transactions|selectattr('blocked')|list|length }}
      </div>
      <div style="color: #6b7280;">Frauds Blocked</div>
    </div>

    <div class="glass-card"
      style="padding: 2rem; text-align: center; background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(30,64,175,0.2));">
      <div style="font-size: 2.5rem; color: #3b82f6; font-weight: bold;">
        â‚¹{{ "%.0f"|format(remaining) }}
      </div>
      <div style="color: #6b7280;">Remaining</div>
    </div>
  </div>

  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
    <!-- Google Charts: Budget vs Spent -->
    <div class="glass-card" style="padding: 2rem;">
      <h3 style="margin-bottom: 1rem; text-align: center;">
        ğŸ“ˆ Overview
      </h3>
      <div id="budgetChart" style="width: 100%; height: 300px;"></div>
    </div>

    <!-- Category Breakdown -->
    <div class="glass-card" style="padding: 2rem;">
      <h3 style="margin-bottom: 1rem;">ğŸ“Š Category Budgets</h3>
      <div style="display: flex; flex-direction: column; gap: 1rem; max-height: 300px; overflow-y: auto;">

        {% set colors = [
        {'main': '#10b981', 'bg': 'rgba(16,185,129,0.1)'},
        {'main': '#f59e0b', 'bg': 'rgba(245,158,11,0.1)'},
        {'main': '#3b82f6', 'bg': 'rgba(59,130,246,0.1)'},
        {'main': '#8b5cf6', 'bg': 'rgba(139,92,246,0.1)'},
        {'main': '#ec4899', 'bg': 'rgba(236,72,153,0.1)'}
        ] %}

        {% for category, details in config.budgets.items() %}
        {% set color = colors[loop.index0 % 5] %}
        <div
          style="padding: 1rem; background: {{ color.bg }}; border-radius: 8px; border-left: 4px solid {{ color.main }};">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="font-weight: bold; font-size: 1.1rem;">{{ category }}</span>
            <span style="color: {{ color.main }}; font-weight: bold;">
              {{ "%.0f"|format((details.spent / details.limit * 100) if details.limit > 0 else 0) }}%
            </span>
          </div>
          <div style="margin-top: 0.5rem; font-size: 0.9rem; color: #555;">
            â‚¹{{ "%.0f"|format(details.spent) }} / â‚¹{{ "%.0f"|format(details.limit) }}
          </div>
          <!-- Progress Bar -->
          <div
            style="background: rgba(0,0,0,0.1); height: 6px; border-radius: 3px; margin-top: 0.5rem; overflow: hidden;">
            <div
              style="background: {{ color.main }}; height: 100%; width: {{ (details.spent / details.limit * 100) if details.limit > 0 else 0 }}%;">
            </div>
          </div>
        </div>
        {% endfor %}

      </div>
    </div>
  </div>

  <!-- Recent Transactions Table -->
  <div class="glass-card" style="padding: 2.5rem;">
    <h3 style="margin-bottom: 1.5rem;">ğŸ•’ Recent Transactions</h3>

    {% if transactions %}
    <div style="overflow-x: auto;">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="border-bottom: 2px solid rgba(0,0,0,0.1); text-align: left;">
            <th style="padding: 1rem;">Merchant</th>
            <th style="padding: 1rem;">Category</th>
            <th style="padding: 1rem;">Amount</th>
            <th style="padding: 1rem;">Risk Score</th>
            <th style="padding: 1rem;">Status</th>
          </tr>
        </thead>
        <tbody>
          {% for t in transactions|reverse %}
          <tr style="border-bottom: 1px solid rgba(0,0,0,0.05); transition: background 0.2s;">
            <td style="padding: 1rem; font-weight: 500;">{{ t.merchant }}</td>
            <td style="padding: 1rem;">
              <span
                style="background: rgba(0,0,0,0.05); padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.85rem;">
                {{ t.category }}
              </span>
            </td>
            <td style="padding: 1rem; font-weight: bold;">â‚¹{{ "%.2f"|format(t.amount) }}</td>
            <td style="padding: 1rem;">
              <span style="
                color: {{ '#ef4444' if t.risk > 70 else '#f59e0b' if t.risk > 40 else '#10b981' }};
                font-weight: bold;
              ">
                {{ t.risk }}
              </span>
            </td>
            <td style="padding: 1rem;">
              {% if t.blocked %}
              <span style="color: #ef4444; font-weight: bold;">ğŸš« Blocked</span>
              {% else %}
              <span style="color: #10b981; font-weight: bold;">âœ… Approved</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div style="text-align: center; padding: 2rem; color: #6b7280;">
      <p>No transactions yet. Start spending! ğŸ’¸</p>
    </div>
    {% endif %}

  </div>

  <!-- Action Buttons -->
  <div style="text-align: center; margin-top: 2.5rem;">
    <a href="{{ url_for('setup') }}" class="btn"
      style="background: linear-gradient(135deg, #1e40af, #3b82f6); margin-right: 1rem;">
      âœï¸ Edit Budget
    </a>
    <a href="{{ url_for('add_payment') }}" class="btn" style="background: linear-gradient(135deg, #10b981, #059669);">
      â• Add UPI Payment
    </a>
  </div>

</div>
{% endblock %}